# load oh-my-zsh
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="agnoster"
plugins=(git)

source $ZSH/oh-my-zsh.sh

# Aliases
alias nano="echo Ahem\?"
alias ap="ansible-playbook"
alias icat="kitty +kitten icat"
alias calc="qalc"
alias fd="fd -L"
alias temp="sensors 2> /dev/null | grep Tctl"
alias systemctl="systemctl --no-pager"
alias j="just"

# Human-readable sizes
alias df='df -h'
alias du='du -h'
alias free='free -h'

# kubernetes things
alias k="kubectl"
# allow using krew plugins
export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"

# Always use dotfile preprocessing with stow
alias stow="stow --dotfiles"

# Enable completion
# https://stackoverflow.com/questions/66338988/complete13-command-not-found-compdef
autoload -Uz compinit
compinit

# Make Ctrl+U work as expected
bindkey \^U backward-kill-line

# Put a space at the start of a command to make sure it doesn't get added to the history.
setopt histignorespace

# History settings
setopt HIST_IGNORE_SPACE      # Don't save commands starting with spaces
setopt HIST_IGNORE_DUPS       # Don't save sequential duplicate entries
setopt HIST_FIND_NO_DUPS      # Hide dups when searching history
setopt HIST_REDUCE_BLANKS     # Remove superfluous blanks from history items
setopt INC_APPEND_HISTORY     # Save history entries as soon as they are entered
setopt SHARE_HISTORY          # Share history between different instances
setopt HIST_VERIFY            # Don't execute immediately after history expansion

# Completion settings

# Case-insensitive completion
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}' 'r:|=*' 'l:|=* r:|=*'

# Highlight selection in completion menu
zstyle ':completion:*' menu select

# Better completion for kill command
zstyle ':completion:*:*:kill:*' menu yes select
zstyle ':completion:*:kill:*' force-list always

# Group completions by type
zstyle ':completion:*' group-name ''
zstyle ':completion:*:descriptions' format '%B%d%b'

# Add go paths to path
if command -v go >/dev/null 2>&1; then
  export PATH="$PATH:$(go env GOBIN):$(go env GOPATH)/bin"
fi

# https://unix.stackexchange.com/a/539771
alias oops=' remove_last_history_entry'

remove_last_history_entry() {
    # This sub-function checks if the argument passed is a number.
    # Thanks to @yabt on stackoverflow for this :).
    is_int() ( return $(test "$@" -eq "$@" > /dev/null 2>&1); )

    # Set history file's location
    history_file="${HOME}/.zsh_history"
    history_temp_file="${history_file}.tmp"
    line_cout=$(wc -l $history_file)

    # Check if the user passed a number,
    # so we can delete x lines from history.
    lines_to_remove=1
    if [ $# -eq 0 ]; then
        # No arguments supplied, so set to one.
        lines_to_remove=1
    else
        # An argument passed. Check if it's a number.
        if $(is_int "${1}"); then
            lines_to_remove="$1"
        else
            echo "Unknown argument passed. Exiting..."
            return
        fi
    fi

    # Make the number negative, since head -n needs to be negative.
    lines_to_remove="-${lines_to_remove}"

    fc -W # write current shell's history to the history file.

    # Get the files contents minus the last entry(head -n -1 does that)
    #cat $history_file | head -n -1 &> $history_temp_file
    cat $history_file | head -n "${lines_to_remove}" &> $history_temp_file
    mv "$history_temp_file" "$history_file"

    fc -R # read history file.
}

# Load .zshrc.local, if it exists
[ -f ~/.zshrc.local ] && source ~/.zshrc.local
